{% extends "base.html" %}
{% block content %}

<script src="https://cdn.tailwindcss.com"></script>


<div class="p-4 bg-white block sm:flex items-center justify-between border-b border-gray-200 lg:mt-1.5 dark:bg-gray-800 dark:border-gray-700">
    <div class="w-full mb-1">
        <div class="mb-4 flex justify-between items-center">
            <h1 class="text-xl font-semibold text-gray-900 sm:text-2xl dark:text-white" id="pageTitle">Second Hand Phones Management</h1>
            <select id="languageSwitch" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="en">English</option>
                <option value="ar">العربية</option>
            </select>
        </div>
    </div>
</div>

<!-- Digital Wallet and Stats Grid -->
<div class="grid grid-cols-1 lg:grid-cols-5 gap-4 my-4">
    <!-- Digital Wallet Card -->
    <div class="lg:col-span-2">
        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow sm:p-6 dark:bg-gray-800 dark:border-gray-700">
            <h5 class="mb-4 text-xl font-medium text-gray-500 dark:text-gray-400" data-lang-en="Digital Wallet" data-lang-ar="المحفظة الرقمية">Digital Wallet</h5>
            <div class="flex items-baseline text-gray-900 dark:text-white mb-4">
                <span class="text-3xl font-semibold">$</span>
                <span class="text-5xl font-extrabold tracking-tight" id="walletBalance">0.00</span>
            </div>
            <div class="flex space-x-2">
                <button type="button" data-modal-target="depositModal" data-modal-toggle="depositModal" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700" data-lang-en="Deposit" data-lang-ar="إيداع">Deposit</button>
                <button type="button" data-modal-target="withdrawModal" data-modal-toggle="withdrawModal" class="flex-1 text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-600 dark:text-white dark:hover:bg-gray-700" data-lang-en="Withdraw" data-lang-ar="سحب">Withdraw</button>
            </div>
            <!-- Recent Transactions -->
            <div class="mt-6">
                <h6 class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-en="Recent Transactions" data-lang-ar="المعاملات الأخيرة">Recent Transactions</h6>
                <div class="mt-2 space-y-2 overflow-y-auto max-h-40 border-t pt-2" id="transactionsList">
                    <!-- Transactions will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- Available Devices Card -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="inline-flex items-center justify-center w-10 h-10 bg-blue-100 rounded-full dark:bg-blue-900">
                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm2 0h12v10H4V5z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-en="Available Devices" data-lang-ar="الأجهزة المتاحة">Available Devices</h5>
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" id="availableDevices">0</div>
                </div>
            </div>
        </div>
        <!-- Total Purchase Price Card -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="inline-flex items-center justify-center w-10 h-10 bg-red-100 rounded-full dark:bg-red-900">
                    <svg class="w-6 h-6 text-red-600 dark:text-red-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM2 9v5a2 2 0 002 2h12a2 2 0 002-2V9H2zm2-3h12v8H4V6z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-en="Total Purchase" data-lang-ar="إجمالي الشراء">Total Purchase</h5>
                    <div class="flex items-baseline text-2xl font-bold text-gray-900 dark:text-white">
                        <span class="mr-1">$</span>
                        <span id="totalPurchase">0.00</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Total Value Card -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="inline-flex items-center justify-center w-10 h-10 bg-green-100 rounded-full dark:bg-green-900">
                    <svg class="w-6 h-6 text-green-600 dark:text-green-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm0 14a6 6 0 110-12 6 6 0 010 12zm-1-9a1 1 0 112 0v3a1 1 0 01-2 0V7zm1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-en="Total Value" data-lang-ar="القيمة الإجمالية">Total Value</h5>
                    <div class="flex items-baseline text-2xl font-bold text-gray-900 dark:text-white">
                        <span class="mr-1">$</span>
                        <span id="totalValue">0.00</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Total Profit Card -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="inline-flex items-center justify-center w-10 h-10 bg-yellow-100 rounded-full dark:bg-yellow-900">
                    <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v2h2v-2zm0-8H9v6h2V5z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-en="Profit" data-lang-ar="المكسب">Profit</h5>
                    <div class="flex items-baseline text-2xl font-bold text-gray-900 dark:text-white">
                        <span class="mr-1">$</span>
                        <span id="totalProfit">0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Devices Table -->
<div class="flex flex-col bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
    <!-- Table Controls -->
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex flex-wrap items-center justify-between gap-4">
        <div class="flex flex-wrap items-center gap-4">
            <div class="relative">
                <svg class="w-5 h-5 text-gray-500 absolute left-3 top-1/2 transform -translate-y-1/2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                </svg>
                <input type="text" id="deviceSearch" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg w-64 pl-10 p-2.5 dark:bg-gray-700 dark:text-white" placeholder="Search devices" data-lang-en-placeholder="Search for devices" data-lang-ar-placeholder="ابحث عن الأجهزة">
            </div>
            <select id="statusFilter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 dark:bg-gray-700 dark:text-white">
                <option value="" data-lang-en="All Status" data-lang-ar="جميع الحالات">All Status</option>
                <option value="available" data-lang-en="Available" data-lang-ar="متاح">Available</option>
                <option value="sold" data-lang-en="Sold" data-lang-ar="مباع">Sold</option>
            </select>
        </div>
        <button type="button" data-modal-target="addDeviceModal" data-modal-toggle="addDeviceModal" class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700" data-lang-en="Add new device" data-lang-ar="إضافة جهاز جديد">Add new device</button>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="p-4" data-lang-en="Image" data-lang-ar="الصورة">Image</th>
                    <th scope="col" class="p-4" data-lang-en="Device Name" data-lang-ar="اسم الجهاز">Device Name</th>
                    <th scope="col" class="p-4" data-lang-en="Owner" data-lang-ar="المالك">Owner</th>
                    <th scope="col" class="p-4" data-lang-en="Purchase Price" data-lang-ar="سعر الشراء">Purchase Price</th>
                    <th scope="col" class="p-4" data-lang-en="Selling Price" data-lang-ar="سعر البيع">Selling Price</th>
                    <th scope="col" class="p-4" data-lang-en="Status" data-lang-ar="الحالة">Status</th>
                    <th scope="col" class="p-4 text-right" data-lang-en="Actions" data-lang-ar="الإجراءات">Actions</th>
                </tr>
            </thead>
            <tbody id="devicesTableBody">
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                    <td class="p-4 w-32"><img src="https://via.placeholder.com/50" class="w-16 h-16 object-cover rounded-lg" alt="Device"></td>
                    <td class="p-4 font-medium text-gray-900 dark:text-white">iPhone 12</td>
                    <td class="p-4">Ahmed</td>
                    <td class="p-4">$300</td>
                    <td class="p-4 text-green-600 dark:text-green-400">$450</td>
                    <td class="p-4">
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Available</span>
                    </td>
                    <td class="p-4 text-right space-x-2">
                        <button class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-xs px-3 py-1.5 dark:bg-blue-600 dark:hover:bg-blue-700" data-lang-en="Edit" data-lang-ar="تعديل">Edit</button>
                        <button class="text-red-700 hover:text-white border border-red-700 hover:bg-red-800 font-medium rounded-lg text-xs px-3 py-1.5 dark:border-red-500 dark:text-red-500 dark:hover:text-white dark:hover:bg-red-600" data-lang-en="Delete" data-lang-ar="حذف">Delete</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Deposit Modal -->
<div id="depositModal" tabindex="-1" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <button type="button" class="absolute top-3 right-2.5 text-gray-400 hover:bg-gray-200 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600" data-modal-hide="depositModal">
                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
            </button>
            <div class="px-6 py-6 lg:px-8">
                <h3 class="mb-4 text-xl font-medium text-gray-900 dark:text-white" data-lang-en="Deposit Funds" data-lang-ar="إيداع الأموال">Deposit Funds</h3>
                <form class="space-y-6" id="depositForm">
                    <div>
                        <label for="depositAmount" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" data-lang-en="Amount" data-lang-ar="المبلغ">Amount</label>
                        <input type="number" name="depositAmount" id="depositAmount" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg w-full p-2.5 dark:bg-gray-600 dark:text-white" required min="0.01" step="0.01" placeholder="0.00">
                    </div>
                    <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700" data-lang-en="Deposit" data-lang-ar="إيداع">Deposit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal" tabindex="-1" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <button type="button" class="absolute top-3 right-2.5 text-gray-400 hover:bg-gray-200 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600" data-modal-hide="withdrawModal">
                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
            </button>
            <div class="px-6 py-6 lg:px-8">
                <h3 class="mb-4 text-xl font-medium text-gray-900 dark:text-white" data-lang-en="Withdraw Funds" data-lang-ar="سحب الأموال">Withdraw Funds</h3>
                <form class="space-y-6" id="withdrawForm">
                    <div>
                        <label for="withdrawAmount" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" data-lang-en="Amount" data-lang-ar="المبلغ">Amount</label>
                        <input type="number" name="withdrawAmount" id="withdrawAmount" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg w-full p-2.5 dark:bg-gray-600 dark:text-white" required min="0.01" step="0.01" placeholder="0.00">
                    </div>
                    <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700" data-lang-en="Withdraw" data-lang-ar="سحب">Withdraw</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div id="addDeviceModal" tabindex="-1" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <button type="button" class="absolute top-3 right-2.5 text-gray-400 hover:bg-gray-200 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600" data-modal-hide="addDeviceModal">
                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
            </button>
            <div class="px-6 py-6 lg:px-8">
                <h3 class="mb-4 text-xl font-medium text-gray-900 dark:text-white" data-lang-en="Add New Device" data-lang-ar="إضافة جهاز جديد">Add New Device</h3>
                <form class="space-y-4" id="addDeviceForm" enctype="multipart/form-data">
                    <div>
                        <label for="deviceImage" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" data-lang-en="Device Image" data-lang-ar="صورة الجهاز">Device Image</label>
                        <input type="file" name="deviceImage" id="deviceImage" accept="image/*" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg w-full p-2.5 dark:bg-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label for="deviceName" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" data-lang-en="Device Name" data-lang-ar="اسم الجهاز">Device Name</label>
                        <input type="text" name="deviceName" id="deviceName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg w-full p-2.5 dark:bg-gray-600 dark:text-white" required>
                    </div>
                    <div>
                        <label for="owner" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" data-lang-en="Owner" data-lang-ar="المالك">Owner</label>
                        <input type="text" name="owner" id="owner" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg w-full p-2.5 dark:bg-gray-600 dark:text-white" required>
                    </div>
                    <div>
                        <label for="purchasePrice" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" data-lang-en="Purchase Price" data-lang-ar="سعر الشراء">Purchase Price</label>
                        <input type="number" name="purchasePrice" id="purchasePrice" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg w-full p-2.5 dark:bg-gray-600 dark:text-white" required min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div>
                        <label for="sellingPrice" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" data-lang-en="Selling Price" data-lang-ar="سعر البيع">Selling Price</label>
                        <input type="number" name="sellingPrice" id="sellingPrice" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg w-full p-2.5 dark:bg-gray-600 dark:text-white" required min="0" step="0.01" placeholder="0.00">
                    </div>
                    <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700" data-lang-en="Add Device" data-lang-ar="إضافة الجهاز">Add Device</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Utility Functions
const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

// Toast Notification
function showToast(message, isSuccess) {
    let toastContainer = $('#toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'fixed top-4 right-4 z-50 space-y-4';
        document.body.appendChild(toastContainer);
    }
    const toast = document.createElement('div');
    toast.className = `flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800 animate-fade-in`;
    toast.innerHTML = `
        <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 ${isSuccess ? 'text-green-500 bg-green-100' : 'text-red-500 bg-red-100'} rounded-lg">
            ${isSuccess ? '<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>' : '<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 11.793a1 1 0 1 1-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 0 1-1.414-1.414L8.586 10 6.293 7.707a1 1 0 0 1 1.414-1.414L10 8.586l2.293-2.293a1 1 0 0 1 1.414 1.414L11.414 10l2.293 2.293Z"/></svg>'}
        </div>
        <div class="ml-3 text-sm font-normal">${message}</div>
        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8" onclick="this.parentElement.remove()">
            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
        </button>
    `;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

// Wallet Management
function getCurrentBalance() {
    return parseFloat($('#walletBalance').textContent);
}

function updateBalance(newBalance) {
    $('#walletBalance').textContent = newBalance.toFixed(2);
}

function addTransaction(type, amount, status = 'Completed') {
    const date = new Date().toISOString().split('T')[0];
    const transaction = document.createElement('div');
    transaction.className = 'text-sm text-gray-700 dark:text-gray-300';
    transaction.textContent = `${date} - ${type} - $${amount.toFixed(2)} - ${status}`;
    const list = $('#transactionsList');
    list.insertBefore(transaction, list.firstChild);
    if (list.children.length > 5) list.lastChild.remove();
}

async function handleDeposit(event) {
    event.preventDefault();
    const form = event.target;
    const amount = parseFloat(form.depositAmount.value);

    if (amount <= 0) {
        showToast('Deposit amount must be greater than 0', false);
        return;
    }

    try {
        const response = await fetch('/deposit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount })
        });
        const data = await response.json();

        if (data.success) {
            const currentBalance = getCurrentBalance();
            updateBalance(currentBalance + amount);
            addTransaction('Deposit', amount);
            showToast('Deposit successful', true);
            form.reset();
            $('#depositModal [data-modal-hide="depositModal"]').click();
        } else {
            showToast(data.error || 'Failed to deposit', false);
        }
    } catch (error) {
        console.error('Deposit Error:', error);
        const currentBalance = getCurrentBalance();
        updateBalance(currentBalance + amount);
        addTransaction('Deposit', amount);
        showToast('Deposit successful (demo)', true);
        form.reset();
        $('#depositModal [data-modal-hide="depositModal"]').click();
    }
}

async function handleWithdraw(event) {
    event.preventDefault();
    const form = event.target;
    const amount = parseFloat(form.withdrawAmount.value);
    const currentBalance = getCurrentBalance();

    if (amount <= 0) {
        showToast('Withdraw amount must be greater than 0', false);
        return;
    }
    if (amount > currentBalance) {
        showToast('Insufficient balance', false);
        return;
    }

    try {
        const response = await fetch('/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount })
        });
        const data = await response.json();

        if (data.success) {
            updateBalance(currentBalance - amount);
            addTransaction('Withdraw', amount);
            showToast('Withdrawal successful', true);
            form.reset();
            $('#withdrawModal [data-modal-hide="withdrawModal"]').click();
        } else {
            showToast(data.error || 'Failed to withdraw', false);
        }
    } catch (error) {
        console.error('Withdraw Error:', error);
        updateBalance(currentBalance - amount);
        addTransaction('Withdraw', amount);
        showToast('Withdrawal successful (demo)', true);
        form.reset();
        $('#withdrawModal [data-modal-hide="withdrawModal"]').click();
    }
}

// Device Management
function validateDeviceForm(formData) {
    const purchasePrice = parseFloat(formData.get('purchasePrice'));
    const sellingPrice = parseFloat(formData.get('sellingPrice'));
    const currentBalance = getCurrentBalance();

    if (!formData.get('deviceName') || !formData.get('owner')) {
        showToast('Please fill all required fields', false);
        return false;
    }
    if (purchasePrice < 0 || sellingPrice < 0) {
        showToast('Prices cannot be negative', false);
        return false;
    }
    return true;
}

async function handleDeviceSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    if (!validateDeviceForm(formData)) return;

    const purchasePrice = parseFloat(formData.get('purchasePrice'));
    const currentBalance = getCurrentBalance();

    try {
        const response = await fetch('/add_device', { method: 'POST', body: formData });
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, true);
            form.reset();
            $('#addDeviceModal [data-modal-hide="addDeviceModal"]').click();
            addDeviceToTable(formData);
            updateStats();
            addTransaction('Device Purchase', purchasePrice);
        } else {
            showToast(data.error || 'Failed to add device', false);
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Device added (demo)', true);
        form.reset();
        $('#addDeviceModal [data-modal-hide="addDeviceModal"]').click();
        addDeviceToTable(formData);
        updateStats();
        addTransaction('Device Purchase', purchasePrice);
    }
}

function addDeviceToTable(formData) {
    const tbody = $('#devicesTableBody');
    const tr = document.createElement('tr');
    const imageUrl = formData.get('deviceImage') ? URL.createObjectURL(formData.get('deviceImage')) : 'https://via.placeholder.com/50';
    const purchasePrice = parseFloat(formData.get('purchasePrice'));
    const sellingPrice = parseFloat(formData.get('sellingPrice'));
    const sellingPriceClass = sellingPrice > purchasePrice ? 'text-green-600 dark:text-green-400' : 'text-gray-900 dark:text-white';
    tr.innerHTML = `
        <td class="p-4"><img src="${imageUrl}" class="w-12 h-12 object-cover rounded" alt="Device"></td>
        <td class="p-4 text-sm text-gray-900 dark:text-white">${formData.get('deviceName')}</td>
        <td class="p-4 text-sm text-gray-900 dark:text-white">${formData.get('owner')}</td>
        <td class="p-4 text-sm text-gray-900 dark:text-white">$${purchasePrice.toFixed(2)}</td>
        <td class="p-4 text-sm ${sellingPriceClass}">$${sellingPrice.toFixed(2)}</td>
        <td class="p-4 text-sm text-gray-900 dark:text-white">Available</td>
        <td class="p-4 text-sm text-right"><button class="text-blue-600 hover:underline" data-lang-en="Edit" data-lang-ar="تعديل">Edit</button></td>
    `;
    tbody.appendChild(tr);
}

function updateStats() {
    const rows = $$('#devicesTableBody tr');
    let availableCount = 0, totalPurchase = 0, totalValue = 0, totalProfit = 0;
    rows.forEach(row => {
        const status = row.cells[5].textContent.toLowerCase();
        const purchasePrice = parseFloat(row.cells[3].textContent.replace('$', ''));
        const sellingPrice = parseFloat(row.cells[4].textContent.replace('$', ''));
        if (status === 'available') {
            availableCount++;
            totalPurchase += purchasePrice;
            totalValue += sellingPrice;
            totalProfit += (sellingPrice - purchasePrice);
            row.cells[4].className = `p-4 text-sm ${sellingPrice > purchasePrice ? 'text-green-600 dark:text-green-400' : 'text-gray-900 dark:text-white'}`;
        }
    });
    $('#availableDevices').textContent = availableCount;
    $('#totalPurchase').textContent = totalPurchase.toFixed(2);
    $('#totalValue').textContent = totalValue.toFixed(2);
    $('#totalProfit').textContent = totalProfit.toFixed(2);
    updateBalance(totalPurchase);
}

function filterDevices() {
    const search = $('#deviceSearch').value.toLowerCase();
    const status = $('#statusFilter').value.toLowerCase();
    const rows = $$('#devicesTableBody tr');
    rows.forEach(row => {
        const name = row.cells[1].textContent.toLowerCase();
        const rowStatus = row.cells[5].textContent.toLowerCase();
        const matchesSearch = name.includes(search);
        const matchesStatus = !status || rowStatus === status;
        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}

// Language Switcher
function switchLanguage(lang) {
    $$('[data-lang-en]').forEach(el => {
        el.textContent = lang === 'en' ? el.dataset.langEn : el.dataset.langAr;
    });
    $$('[data-lang-en-placeholder]').forEach(el => {
        el.placeholder = lang === 'en' ? el.dataset.langEnPlaceholder : el.dataset.langArPlaceholder;
    });
}

// Event Listeners
$('#depositForm').addEventListener('submit', handleDeposit);
$('#withdrawForm').addEventListener('submit', handleWithdraw);
$('#addDeviceForm').addEventListener('submit', handleDeviceSubmit);
$('#deviceSearch').addEventListener('input', debounce(filterDevices, 300));
$('#statusFilter').addEventListener('change', filterDevices);
$('#languageSwitch').addEventListener('change', (e) => switchLanguage(e.target.value));

// Utility: Debounce function
function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Initial Setup
updateStats();
switchLanguage($('#languageSwitch').value);

// CSS Animation for Toast
const style = document.createElement('style');
style.textContent = `
    @keyframes fade-in {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}